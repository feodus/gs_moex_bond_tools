# Архитектура решения MOEX Bond Data for Google Sheets

## Общая архитектура

Проект представляет собой библиотеку Google Apps Script, реализующую кастомные функции для получения данных об облигациях с Московской Биржи. Архитектура построена по принципу "один файл - одна библиотека", с использованием встроенных механизмов Google Apps Script для кэширования и работы с API.

## Структура проекта

- `gs_moex_bond_tools/script.js` - основной файл с логикой приложения
- `gs_moex_bond_tools/appscript.json` - конфигурация Google Apps Script
- `.kilocode/rules/memory-bank/` - файлы Memory Bank
- `docs/` - документация
- `package.json`, `.eslintrc.json`, `.prettierrc` - файлы конфигурации инструментов разработки

## Ключевые компоненты

### Кастомные функции

1. **GET_MOEX_PRICE** - получение текущей цены облигации
   - Использует кэширование на 5 минут
   - Запрашивает данные из marketdata и securities
   - Обрабатывает LAST, CLOSEPRICE, PREVLEGALCLOSEPRICE, PREVPRICE

2. **GET_NEXT_COUPON** - получение даты следующего купона
   - Использует кэширование на 6 часов
   - Запрашивает поле NEXTCOUPON из securities

3. **GET_MOEX_NAME** - получение наименования облигации
   - Использует кэширование на 24 часа
   - Запрашивает SECNAME или SHORTNAME из securities

4. **GET_COUPON_VALUE** - получение размера следующего купона
   - Использует кэширование на 6 часов
   - Имеет поддержку флоатеров через fallback на bondization

5. **GET_MATURITY_DATE** - получение даты погашения
   - Использует кэширование на 24 часа
   - Запрашивает поле MATDATE из securities

6. **GET_NEAREST_OPTION_DATE** - получение ближайшей даты опциона/амортизации
   - Запрашивает данные из bondization (amortizations и offers)
   - Возвращает ближайшее будущее событие

### Вспомогательные функции

- `onOpen()` - создает меню MOEX при открытии таблицы
- `forceRecalculatePrices()` - массовое обновление всех ячеек с кастомными функциями
- Внутренние функции с суффиксом `Internal` для обработки логики

## Архитектурные паттерны

### Кэширование

- Используется `CacheService.getScriptCache()`
- Разные интервалы кэширования для разных типов данных:
  - Цены: 5 минут (300 секунд)
  - Даты купонов: 6 часов (21600 секунд)
  - Наименования и даты погашения: 24 часа (86400 секунд)
  - Размеры купонов: 6 часов (21600 секунд)

### Обработка ошибок

- Обработка HTTP-кодов ответов
- Проверка структуры полученных данных
- Возврат описательных сообщений об ошибках
- Защита от null/undefined значений

### Работа с API MOEX

- Использование `UrlFetchApp.fetch()` для HTTP-запросов
- Построение URL с параметрами для получения данных
- Обработка JSON-ответов с разными структурами
- Fallback-механизмы для разных типов облигаций

## Критические пути реализации

### Получение цены облигации

1. Проверка кэша
2. Формирование URL запроса к MOEX API
3. Выполнение запроса
4. Анализ ответа из marketdata и securities
5. Поиск цены по приоритету (LAST, CLOSEPRICE, PREVLEGALCLOSEPRICE, PREVPRICE)
6. Кэширование результата
7. Возврат результата

### Получение размера купона

1. Попытка получения из основного API (COUPONVALUE)
2. Если значение отсутствует или равно 0 - fallback на bondization
3. В bondization поиск следующего купона или последнего известного (для флоатеров)

### Массовое обновление

1. Сканирование всех ячеек с кастомными функциями
2. Обновление каждой ячейки с задержкой 400мс для предотвращения превышения лимитов API

## Интеграции

- MOEX ISS API - основной источник данных об облигациях
- Google Sheets API - для интеграции с таблицами
- Google Apps Script Cache Service - для кэширования данных
