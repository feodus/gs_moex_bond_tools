# Текущий контекст проекта

## Состояние на 15 января 2026 года

Проект MOEX Bond Data for Google Sheets продолжает активную разработку. Это библиотека Google Apps Script, которая предоставляет пользовательские функции для получения данных об облигациях с Московской Биржи прямо в Google Таблицах. Проект успешно переименован из rebalance_bonds_11-2025 в gs_moex_bond_tools.

## Текущая функциональность

- Реализованы основные функции для получения данных об облигациях:
  - GET_MOEX_PRICE - текущая цена облигации
  - GET_MOEX_NAME - наименование облигации
  - GET_NEXT_COUPON - дата следующего купона
  - GET_COUPON_VALUE - размер следующего купона
  - GET_MATURITY_DATE - дата погашения
  - GET_NEAREST_OPTION_DATE - ближайшая дата опциона или амортизации
- Встроена система кэширования для оптимизации запросов к API
- Добавлена функция массового обновления данных с задержками
- Реализована поддержка флоатеров (облигаций с плавающей ставкой)
- Внедрена система логирования и обработки ошибок

## Архитектурные особенности

- Используется Google Apps Script с runtime V8
- Все функции реализованы как Custom Functions для использования в ячейках
- Применяется кэширование с разными интервалами для разных типов данных:
  - Цены: 5 минут (300 секунд)
  - Даты купонов: 6 часов (21600 секунд)
  - Наименования и даты погашения: 24 часа (86400 секунд)
  - Размеры купонов: 6 часов (21600 секунд)
- Используются API MOEX для получения данных об облигациях
- Реализована защита от превышения лимитов API
- Внедрена система валидации входных данных

## Текущие задачи

- Поддержка и улучшение стабильности работы с API MOEX
- Расширение покрытия различных типов облигаций
- Оптимизация производительности и улучшение обработки ошибок
- Улучшение системы кэширования и валидации данных

## Выявленные и устраненные проблемы

После анализа кода файла script.js были выявлены и учтены следующие аспекты:

1. Проблема с обработкой кэшированных дат - при десериализации теряется тип Date (реализовано преобразование в функциях)
2. Непоследовательная обработка пустых тикеров в функции GET_NEAREST_OPTION_DATE (обрабатывается корректно)
3. Проблема с установкой примечаний в UDF - функция пытается установить примечание, что не работает в контексте пользовательских функций (реализована защита от ошибок)
4. Неоптимальная обработка ошибок - теперь возвращаются более детализированные сообщения
5. Потенциальное превышение лимитов API при массовом обновлении (реализована задержка 400мс между запросами)
6. Валидация входных данных теперь более строгая
7. Кэширование работает корректно с тикерами
8. Сканирование формул в forceRecalculatePrices оптимизировано
9. Обработка флоатеров улучшена с fallback на bondization
